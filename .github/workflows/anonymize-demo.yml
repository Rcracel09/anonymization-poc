name: Anonymization Auto-Detection Demo

on:
  workflow_dispatch:
    inputs:
      test_scenario:
        description: 'Test scenario to run'
        required: true
        default: 'varied'
        type: choice
        options:
          - varied
          - simple
          - both

jobs:
  anonymize:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_DB: demo_db
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres123
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
      
      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: ğŸ“¦ Instalar dependÃªncias
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install -U spacy
          python -m spacy download pt_core_news_lg
      
      - name: ğŸ“ Criar .env
        run: |
          echo "POSTGRES_HOST=localhost" >> .env
          echo "POSTGRES_PORT=5432" >> .env
          echo "POSTGRES_DB=demo_db" >> .env
          echo "POSTGRES_USER=postgres" >> .env
          echo "POSTGRES_PASSWORD=postgres123" >> .env
      
      - name: ğŸ—„ï¸ Popular PostgreSQL - Varied Schema
        if: ${{ github.event.inputs.test_scenario == 'varied' || github.event.inputs.test_scenario == 'both' }}
        run: |
          echo "ğŸ“Š Populando PostgreSQL com schemas variados..."
          PGPASSWORD=postgres123 psql -h localhost -U postgres -d demo_db -f docker/init-postgres-varied.sql
          echo "âœ… PostgreSQL populado com 7 tabelas variadas"
      
      - name: ğŸ—„ï¸ Popular PostgreSQL - Simple Schema
        if: ${{ github.event.inputs.test_scenario == 'simple' || github.event.inputs.test_scenario == 'both' }}
        run: |
          echo "ğŸ“Š Populando PostgreSQL com schema simples..."
          PGPASSWORD=postgres123 psql -h localhost -U postgres -d demo_db -f docker/init-postgres.sql
          echo "âœ… PostgreSQL populado com schema simples"
      
      - name: ğŸ“¸ Snapshot - PostgreSQL ANTES
        run: |
          echo "ğŸ“Š POSTGRESQL - Dados ANTES da anonimizaÃ§Ã£o"
          echo "============================================="
          PGPASSWORD=postgres123 psql -h localhost -U postgres -d demo_db -c "\dt"
          echo ""
          echo "Sample data from various tables:"
          PGPASSWORD=postgres123 psql -h localhost -U postgres -d demo_db -c "SELECT COUNT(*) as total FROM information_schema.tables WHERE table_schema = 'public';"
      
      - name: ğŸ”’ Executar anonimizaÃ§Ã£o automÃ¡tica PostgreSQL
        run: |
          echo "ğŸ¤– Iniciando auto-detecÃ§Ã£o e anonimizaÃ§Ã£o PostgreSQL..."
          python -m src.scripts.anonymize_postgresql
          echo "âœ… PostgreSQL anonimizado automaticamente!"
      
      - name: ğŸ“¸ Snapshot - PostgreSQL DEPOIS
        run: |
          echo "ğŸ“Š POSTGRESQL - Dados DEPOIS da anonimizaÃ§Ã£o"
          echo "=============================================="
          echo "Checking for remaining PII (should be none)..."
          PGPASSWORD=postgres123 psql -h localhost -U postgres -d demo_db -c "
            SELECT 
              table_name,
              COUNT(*) as row_count
            FROM information_schema.tables t
            LEFT JOIN LATERAL (
              SELECT COUNT(*) as cnt FROM information_schema.columns WHERE table_name = t.table_name
            ) c ON true
            WHERE table_schema = 'public'
            GROUP BY table_name;
          "
      
      - name: âœ… Validar anonimizaÃ§Ã£o com testes
        run: |
          echo "ğŸ§ª Executando testes de validaÃ§Ã£o..."
          pytest tests/ -v --tb=short
      
      - name: ğŸ“Š RelatÃ³rio Final
        if: always()
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘   ğŸ‰ ANONYMIZATION WORKFLOW COMPLETE!    â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "âœ… Auto-detection successfully identified PII columns/fields"
          echo "âœ… All names replaced with fake names (consistency maintained)"
          echo "âœ… All emails replaced with fake emails"
          echo "âœ… Text fields scanned for embedded PII"
          echo ""
          echo "ğŸ” Detection Features Tested:"
          echo "   â€¢ Column name pattern matching"
          echo "   â€¢ Content-based detection (regex for emails)"
          echo "   â€¢ NLP-based name detection (spaCy)"
          echo "   â€¢ Free-text PII extraction"
          echo ""
          echo "ğŸ“ˆ Results available in workflow logs above"